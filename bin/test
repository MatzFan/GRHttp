#!/usr/bin/env ruby

require 'pathname'
Root ||= Pathname.new(File.dirname(__FILE__)).expand_path
Dir.chdir Root.join('..').to_s
require "bundler/setup"
require "grhttp"

# You can add fixtures and/or initialization code here to make experimenting
# with your gem easier. You can also use a different console, if you like.

# (If you use this, don't forget to add pry to your Gemfile!)
# require "pry"
# Pry.start
module MyServer
    module_function
    def on_open e
        puts 'WebSocket Open!'
        e << 'Hello!'        
    end
    def on_message e
        e << e.data
    end
    def on_close e
        puts 'WebSocket Closed!'
    end
    def call request, response
      if request.upgrade?
        return false if request.path == '/refuse'
        return self
      end
      return false if request.path == '/refuse'
      response << "Hello World!\r\n\r\nThe Request:\r\n#{request.to_s}"
    end
end

GRHttp.start do
    GRHttp.listen upgrade_handler: MyServer, http_handler: MyServer
end
